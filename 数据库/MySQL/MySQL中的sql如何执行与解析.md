# MySQL中的sql如何执行与解析

### MySQL 驱动

我们的系统在和 MySQL 数据库进行通信的时候是MySQL 驱动在底层帮我们做了对数据库的连接，只有建立了连接了，才能够有后面的交互。

![image-20220708112020316](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-7/202207081120365.png)

不过在实际使用中肯定是多用户的情况，一般web系统是部署在tomcat容器中，然后tomcat并发处理多个请求，这就导致每个请求都要建立连接，java 系统在通过 MySQL 驱动和 MySQL 数据库连接的时候是**基于 TCP/IP 协议**的，所以如果**每个请求**都是新建连接和销毁连接，那这样势必会造成不必要的浪费和性能的下降，所以就用到了数据库连接池技术。

> **数据库连接池**：维护一定的连接数，方便系统获取连接，使用就去池子中获取，用完放回去就可以了，我们不需要关心连接的创建与销毁，也不需要关心线程池是怎么去维护这些连接的。

<img src="https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-7/202207081129357.png" alt="image-20220708112914290"  />

MySQL 的架构体系中也已经提供了这样的一个池子，也是数据库连池。双方都是通过数据库连接池来管理各个连接的，这样一方面线程之前不需要是争抢连接，更重要的是不需要反复的创建的销毁连接。

### 网络连接必须由线程来处理

网络中的连接都是由线程来处理的，所谓网络连接说白了就是**一次请求**，每次请求都会有相应的线程去处理的。也就是说对于 SQL 语句的请求在 MySQL 中是由一个个的**线程去处理**的。

### SQL 接口

MySQL 中处理请求的线程在获取到请求以后获取 SQL 语句去交给 SQL 接口去处理。

### 查询解析器

将 SQL 接口传递过来的 SQL 语句进行解析，翻译成 MySQL 自己能认识的语言，解析之后还要选择**最优的查询路径**

### MySQL 查询优化器

> 查询优化器内部具体怎么实现的我们不需要是关心，我需要知道的是  MySQL  会帮我去使用他自己认为的最好的方式去优化这条  SQL  语句，并生成一条条的执行计划，比如你创建了多个索引，MySQL 会依据成本最小原则来选择使用对应的索引，这里的成本主要包括两个方面, IO 成本和 CPU 成本

**IO 成本**: 即从磁盘把数据加载到内存的成本，默认情况下，读取数据页的 IO 成本是 1，MySQL 是以页的形式读取数据的，即当用到某个数据时，并不会只读取这个数据，而会把这个数据相邻的数据也一起读到内存中，这就是有名的程序局部性原理，所以 MySQL 每次会读取一整页，一页的成本就是 1。所以 IO 的成本主要和页的大小有关

**CPU 成本**：将数据读入内存后，还要检测数据是否满足条件和排序等 CPU 操作的成本，显然它与行数有关，默认情况下，检测记录的成本是 0.2。

MySQL 优化器 会计算 「IO 成本 + CPU」 成本最小的那个索引来执行，优化器执行选出最优索引等步骤后，会去调用存储引擎接口，开始去执行被 MySQL 解析过和优化过的 SQL 语句

### 存储引擎

查询优化器会调用存储引擎的接口，去执行  SQL，也就是说真正执行  SQL  的动作是在存储引擎中完成的。数据是被存放在内存或者是磁盘中的（存储引擎是一个非常重要的组件，后面会详细介绍）

### 执行器

执行器是一个非常重要的组件，因为前面那些组件的操作最终必须通过执行器去调用存储引擎接口才能被执行。执行器最终最根据一系列的执行计划去调用存储引擎的接口去完成  SQL  的执行

![image-20220708114452189](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-7/202207081144256.png)