# 5、什么是事件风暴？

常规的业务需求到功能代码的转换流程如下图所示：

![img](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-9/d36039c4a75640d9aa260e3e8164070c~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

可以看到：用户的需求经过**层层的转换**才被转发到了研发人员这里，研发人员又会根据会议中获取到的需求**自我转化**功能的实现。

相信这是大多数研发同学开发需求的流程（当然还有比较坑的产品或者项目人员可能直接给你口述一下功能，连个文档都没有，直接让你干），那这种流程和方式会存在什么问题呢？一个需求经过了这么多道的层层转化，需求在每一层都会经过不同人的理解转化，会导致**信息不对称**问题的出现。

**那么 DDD 是如何消除需求分析与同步过程中的信息不对称呢？**

从工程角度来看，DDD 很多专有名词与结构划分都是基于解耦模式下的套路。从落地 DDD 的过程来看，有两个问题是最困难且最重要的：一个是**界定出一个系统中有多少个聚合**，即划分多少个业务模型；另一个是**界定出每个聚合之间的限界上下文**，即划分清楚领域的业务边界。

为了解决以上两个痛点问题，一种被叫作**事件风暴**的轻量型系统分析方法被提出。

## 一、事件风暴的概念及流程

**事件风暴是一套 Workshop（类似于头脑风暴）的方法。它以事件为出发点，通过多人协作来划分业务领域与业务边界。**

**事件风暴的分析过程就像在讲述一个个的用户故事**。通过一个个的用户故事来统一开发人员、业务人员、UX、测试等项目参与者对业务流程的认知，这包括关键的流程、核心的业务规则、系统不同模块的使用。其次是帮助开发人员梳理清楚领域模型与业务边界。

那么用户故事又是怎么分析出来的呢？

下图是事件风暴对于用户故事的分析的**最简核心流程**：

![img](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-9/63ba4dee2bb2465390778baac9acc4e6~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

- **事件：** 代表了某一个业务行为，是事件风暴中的核心概念，所有的分析都以事件为核心展开。描述的形式为“宾语+动词”的过去式。例如，合同已被签署、资料已被上传，等等。使用橙色的便利贴标示。
- **命令/动作：** 表示产生事件的对象，执行了动作之后就会产生相应的事件。例如，“签署合同”命令导致“合同已被签署”事件。使用蓝色的便利贴标示。
- **角色/执行者：** 表示产生命令的对象。例如，顾客执行“签署合同”动作，这里的顾客即为角色/执行者。使用黄色便利贴标示。

也就是说，**事件风暴的核心流程就是：用户执行了命令，从而产生了事件**。

当然上面的只是一个理想化的最简业务流程。但事实上，一个业务系统的业务逻辑绝不是这么简单的。比如，“合同已被签署”事件发生后，需要通知财务系统触发“发起扣款”动作；根据签署合同的类别产生“发送优惠券”的动作；以上两种动作都会导致产生新的事件。

下图是事件风暴对于用户故事的分析的**完整流程**：

![image.png](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-9/b9a0c942bda44a0b8ad979fe6a0ed53f~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

这是上面最简核心流程图的延伸，不过除了角色/执行者、命令/动作、事件这三个核心要素外，还多出了策略/业务规则、数据/读模型和外部系统这三者。

- **策略/业务规则：** 当产生事件时，需要进行某些业务相关的规则校验，例如“合同已被签署后”事件，根据签署合同的类别产生“发送优惠券”的动作。使用粉色便利贴标示。
- **数据/读模型：** 事件产生后的另一个结果往往是呈现用户所关心的数据在系统界面。例如，当用户执行“签署合同”的命令之后，生成了“合同已被签署”事件，此时呈现在用户面前的应该是被签署后的合同信息。这样的数据我们使用读模型表示。使用绿色便利贴标示。
- **外部系统：** 事件并不一定由执行者执行命令产生，也可能由一个外部系统产生。例如，“合同已被签署”事件完成后通知给财务系统，财务系统触发“发起扣款”动作，产生“扣款已完成”事件。使用红色便利贴标示。

因此，在分析一个业务系统前，首先要做的就是搞清楚我们想要的业务结果（事件）是什么，从事件出发开始反推产生事件的动作、外部因素与业务规则。再根据动作进行反推分析本系统内的动作汇聚发起点的业务汇聚在何处。

**汇聚点即为某一个业务领域的聚合，一个个事件与动作的组合就是领域的业务逻辑，根据业务逻辑来设计领域所需要的属性。**

## 二、事件风暴的开展事项

了解完事件风暴的概念及相关核心要素后，你肯定也很好奇应该如何来开展事件风暴。一般来说，事件风暴主要包括参与人员、准备工作和建模讨论这三个大的事项。

**第一个事项，参与人员。** 事件风暴采用 Workshop 的方式。任何与项目相关的业务人员、架构人员、研发人员等都可以参与其中。

**第二个事项，准备工作。** 需要准备一面大的画板或者墙，以及数张不同颜色的便利贴（包括蓝色、黄色、红色、橙色、绿色、粉色、紫色），不同颜色的便利贴对于事件风暴有不同的意义。

**第三个事项，建模讨论。** 常规情况下还是由产品经理先讲解自己梳理的需求点，划分事件，以事件为中心点扩散推导出第一个版本的用户故事。与会人员对于上面张贴出的流程进行头脑风暴，对于需要补充的流程节点使用特定颜色的便利贴进行张贴。讨论结束后，对于事件风暴结果进行拍照或者以其他记录方式存档。

## 三、案例演示

这里我们以`电商分期购车订单业务场景`为例来看看事件风暴的分析流程，如下图：

![img](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-9/c4a8ca323de34ccba549bb4e83b773fb~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

参与人员与准备工作啥的就不说了，需求评审时自行准备即可。

跟前面“建模讨论”处开头说的一致，产品从用户或者需求分析师处调研得到第一版需求后，需要先整理出第一个版本的事件列表，并且根据时间的先后顺序进行排列。

这里以“购车合同已签署”事件为例，看如何分析业务流程。

1. 确定当前事件触发的动作：**签署购车合同。**
2. 签署事件发生后通知**合同服务**保存签署结果，由于合同服务是外部系统，且后续逻辑不会回调，故不延展分析。
3. 签署合同发生后通知**金融订单**服务，金融订单处理自己系统业务逻辑后，回调本系统逻辑，本系统调用**启动金融 task 任务**动作。
4. 动作分析完成则进行反推，触发当前动作的执行者是用户，而能够签署合同的前提是存在订单，订单才是签署合同的业务载体。至此已经得到了业务的聚合为**订单**。
5. **签署购车合同**完成后将产生签署后的合同，用户可通过查看订单中的合同信息查询到，此处即为读模型。

按照上面的思考与探索方式，**根据约定的事件进行反推与逻辑归并，最后将得到业务领域聚合**。比如，上图的分期购车逻辑将会反推得到订单领域，再根据订单所承载的业务逻辑得到订单的业务属性（从上可得知订单合同签署状态与关联的合同信息是订单的业务属性）。订单的业务属性被敲定后，即可**自顶向下将业务模型开始转化为数据模型**。

## 四、总结

事件风暴的方法论本身不是单纯为了 DDD 而生的，但是它是 DDD 在自顶向下领域建模过程中必不可少的分析步骤。

这一讲我们从事件风暴概念出发介绍了事件风暴的分析流程，然后还通过电商购车的例子帮助你更好地去理解事件风暴的实操。

通过事件风暴，我们能够得到业务参与人总结出的业务聚合与聚合所承载的逻辑功能，进而分析得到业务聚合所包含的业务属性。完成业务建模后，就可以根据业务模型去设计数据模型了。这种自顶而下的分析模式从业务角度出发，**让数据模型更加适配业务模型**，而不是常规 MVC 设计下的数据模型去套用业务模型。

同样，在这一讲的学习过程中，如果你遇到什么问题或者有好的经验要分享，欢迎你在留言区与我分享，我们一起交流，一起进步。

---

> DDD最重要的点是：要有专业的产品 不是画图的产品 不是一句话的产品，是对业务领域极其熟悉的产品。