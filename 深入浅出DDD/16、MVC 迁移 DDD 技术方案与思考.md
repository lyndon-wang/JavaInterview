# 16、MVC 迁移 DDD 技术方案与思考

理论与Demo实践都学习完成后，我们就要思考如何在工作中落地DDD了。

目前大多数的公司都是在使用MVC的分层，且数据库的ORM框架都是使用的 MyBatis。因此本文将为你介绍如何在将MyBatis作为ORM框架的情况下，将系统从MVC三层架构迁移至DDD架构的迁移操作。

## 一、ORM 框架是否需要切换

在前面 “DDD的仓储落地”文章中我们分析过使用仓储操作Dao层时，ORM框架选JPA还是MyBatis的问题。

```
在开始的时候我为你分析两个ORM框架的差异，最后收尾的时候还是建议你使用JPA。
```

上述的建议都是建立在你选择使用DDD去做一个新项目的情况，没有任何历史包袱，并且你对JPA的使用也很熟练，那JPA确实是一个较好的选择。

但如果你是基于现有MVC框架在进行迁移，历史包袱比较重。这种情况下如果你为了使用新的技术框架而去动到底层的ORM框架，显然这个操作对于代码可维护性的Buff微乎其微，但是切换ORM框架多出来的工作量却极其繁琐。

还有就是如果团队里面大家对JPA使用的不多，都是MyBatis的技术栈成员，我也建议大家不要轻地更换ORM框架。毕竟，架构与技术栈终究是为业务服务的，但是如果写业务的人都不熟悉技术栈，那业务的维护难度会变得更加困难。

**因此，如果你是历史项目迁移DDD，我建议继续使用原有的ORM框架，一些方法逻辑还能复用。如果你是新项目，且对JPA使用很熟，那我推荐使用JPA。**

## 二、MVC 迁移 DDD 技术方案

我们切换系统依赖的小组件能够无感切换，但是在切换主系统分层架构时必定是伤筋动骨的。而且在系统升级的过程中，我们还要照顾到现有框架下需求迭代与Bug修复。

因此，我们将从简入繁，分步骤进行框架迁移，并通过在迁移过程中增加单测用例的方式保证迁移完成后系统能够顺利运行。

### （1）建立 Maven 包

参考《DDD-Demo 演示（一）：分包与分层》中的分包与分层的规范，建立符合六边形架构的Maven包与文件夹。

项目的层级结构如下所示：

![image-20211221111319702.png](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-10/4959f28e77854763a209e1df97482b05~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

### （2）建立仓储

建立完DDD的Maven结构后，我一般最先开始做的就是建立仓储层。因为仓储层的迁移步骤很简单，并且能够让上层业务模型与底层数据模型更好地隔离开来。

**我们以建立用户仓储为例**

用户表持久化对象：UserPO

用户Dao：UserMapper

```
迁移步骤如下：
```

1. 新建User聚合根，字段与UserPO保持一致。
2. 新建UserConverter，用户互相转换UserPO与User。此处可以增加单元测试保证领域模型与数据模型的转换100%正确。
3. 新建UserRepository接口和实现类，将UserMapper中的方法迁移至repository，入参与出参从PO更换为聚合根。此处可以增加单元测试保证领域模型的增删改查100%成功。
4. 将业务代码中的UserPO更换为User，将UserMapper更换为UserRepository。增加单元测试保证原业务接口逻辑正确。

**此处需要注意的是，迁移过程中UserRepository并没有按照标准的DDD的repository的做法仅包含save、saveAndFlush、byId、delete四个方法。目前仓储内的方法与Mapper内一致，都是带有业务含义的。这些业务方法只是一个中间态，最终都是需要去除的。**

### （3）适配三方依赖

防腐层的抽象也是比较容易操作的，思想与仓储的迁移非常类似。

因为当前领域层还没有建立完成，所以我们需要适配外部服务的调用（RPC，HTTP请求等），内部的防腐可以根据领域层建立完成之后再处理。

```
迁移步骤如下：
```

1. 在domain层新建adpter包，在内部分别定义系统中使用到的RPC或者HTTP请求的adapter接口。
2. 在domain层中定义当前系统所能提供的入参（Query，Command）与出参结构（DTO）。
3. 在infrastructure层定义adapter的实现，转换内部的入参调用外部服务，将返回的接口转换成内部出参。增加单测保证访问外部请求正确。
4. 将系统中所有调用上述RPC与HTTP请求的地方修改成adapter调用，并增加单元测试保证业务逻辑正确。

### （4）抽离技术组件

这部分主要对中间件（比如MqProducer、RedisUtil等）的调用进行抽离。

```
迁移步骤如下：
```

1. 将调用中间件的接口定义在domain包；
2. 定义接口实现类在基础设施层；
3. 替换系统中引用中间件的代码，增加单元测试保证正确性。

### （5）CQRS 迁移落地

这一步主要是为了区分系统中指令性与查询性的业务逻辑，让指令性的业务切合DDD建模。

```
迁移步骤如下：
```

1. 梳理Service中增删改的逻辑与查询的逻辑，针对查询逻辑新建一个查询的的Service，将逻辑迁移至此。
2. 对于增删改的逻辑入参修改为Command，查询逻辑入参修改为Query。
3. 替换系统中的增删改查引用关系，增加单元测试保证迁移正确性。

### （6）领域建模

这一步是迁移过程中最复杂的一步了，我们需要重新设计聚合与实体，根据限界上下文将系统中的贫血模型转换成数据模型。

```
迁移步骤如下：
```

1. 梳理现有系统内业务逻辑，按照事件风暴的建模操作划分好系统内的领域模型。
2. 修改第（1）步中新建的聚合根，将聚合属性内部的字段进行实体与值对象的包装。
3. 根据限界上下文，梳理原先PO层对应的Dao层的业务方法合并至聚合根中，将仓储变为标准的DDD仓储。
4. 根据限界上下文，将原有Service中属于领域模型的逻辑迁移至对应的聚合根内。
5. 根据限界上下文，将原子化多领域协调逻辑放入至领域服务中。
6. 修改Service中的业务逻辑调用，将业务逻辑替换成领域逻辑或者领域服务逻辑。
7. 增加单元测试保证迁移正确。

### （7）编排业务流程

这一步就是落地我们的应用服务了。其实在上一步领域建模完成后，已经把大量Service中的逻辑内聚到了对应的领域服务与领域模型中。所以在这里我们只要按照应用服务的编码规范做一下调整就好了，如果应用服务之间存在互相调用的情况，我们可以建立能力层来衔接。

```
迁移步骤如下：
```

1. 将查询的Service改名为queryApplicationService，查询逻辑因为是为了切合页面展示的，可以不做过多操作。
2. 将增删改的Service改名为applicationService，按照应用服务规范二次整合内部逻辑，必要情况下抽离能力层。
3. 非当前功能点的业务逻辑串联使用事件驱动模型来解耦。
4. 增加单元测试保证迁移正确。

### （8）整合用户交互层

这一步就没什么难度，就是把Controller、MQ、RPC调用等外部输入放在用户交互层的包下即可。

可能很多历史项目里面在Controller、MQ、RPC等实现处也有很多业务逻辑，这部分的逻辑需要交给应用服务去编排，领域模型去实现。用户交互层应该只是外部请求的路由入口，是很薄的一层。

最后别忘了增加单元测试保证迁移正确。

**上面的每一步如果都能按照迁移规范进行操作，等到迁移完成时，你的系统单元测试的覆盖率至少也达到了80%以上了。不论从架构可维护性还是代码的健壮性看，你的系统都焕然一新。**

## 三、跳出 DDD 重新思考架构

其实对于**急需调整架构的系统**而言，除非你做好了基本上要重写整个系统的准备，否则，我其实不太推荐使用DDD直接迁移的。

急需调整架构的系统（传说中的“屎山”）意味项目架构已经极其混乱了，这种时候你如果使用DDD去进行迁移，到了迁移的第（6） 步领域模型时，你将会非常难受。

**你需要翻阅所有系统的业务代码，然后梳理里面的业务逻辑。**

这个步骤是不是想想都头疼？别说梳理所有的逻辑了，你让我再里面改个bug我可能还要debug好久才能找到问题。这种时候，你让我领域驱动设计？

**那难道DDD在这种系统下就没有用武之地了吗？**

我们一直强调的是DDD是一种方法论，它是以战略思想为主去解耦与内聚系统业务的。什么应用服务、领域服务这些都是为了切合它的战略思想而演变出来的战术实现而已。

我们可以直接按照第（2）步拿到的数据模型字段映射版本的聚合根进行操作，将能够适配的业务逻辑放至聚合根内。这样虽然整个系统我们没有按照DDD的方式在进行逻辑组合，但是后续我们碰到新功能的时候，专属于“表聚合”的逻辑我们可以放在聚合根内，至少让业务内聚起来。

同样的，我们也完全可以不用分层思想，但是这完全不妨碍我们使用适配器来防腐外部系统、使用仓储防腐数据模型、使用事件驱动模型防腐监听业务。

**所以，如果历史系统完全迁移DDD困难的，我们可以选择其中比较好落地的那些战术思想来优化现有系统，至少让代码维护起来不会那么痛苦。**

## 四、总结

本文主要为你介绍了如何将系统从MVC迁移至DDD的步骤与思路，并对迁移时是否需要更换ORM框架做了讨论。

文章的最后我们讨论了DDD在落地与迁移过程中可能会遇到的那些难点。DDD在战略思想下提供了战术指导，我们完全可以选择其中比较好落地的操作来优化系统。

**我始终认为做架构不能照搬照抄，适合的才是最好的。**