# 战略设计：业务内聚与解耦

在上一节文章中，我们已经了解了 DDD 的核心思想。那么，从上帝视角来看，DDD 具体是通过什么样的设计去解耦与内聚业务的呢？

本文将从 DDD 的战略设计给你介绍 DDD 在业务与架构层面的核心理论。

首先我们要明白的是，DDD 不是 MVC 那种**业务通用性的分层架构**（任何业务都能按照固定的技术形态进行套用）。它不是一个固定的技术工具形态，针对不同的业务它有不同的呈现方式。但是它也不是没有规律可循的。DDD 的核心战略目标是**解耦与内聚**，为了完成这个战略目标，它定义了**领域、子域、限界上下文、通用语言、上下文映射图和架构风格**的概念。

## 一、领域与子域

DDD 的英文是 Domain Drive Design，直译过来就是**领域驱动设计**。由此可见，领域是 DDD 架构落地设计的核心。

**那么，领域的概念是什么？** 百度百科上对此的翻译是：

> 一种专门活动或事业的范围、部类或部门。

而在 DDD 中，领域本身并不是一个学术性很强的概念，任何边界明确的业务都能被称为领域。比如，一个电商平台中，订单、物流、支付等都是这个平台的领域。

**针对一个领域做二次划分它就是子域了**。领域和子域都是相对的概念。如果把电商平台看成一个大的电商领域，那么订单、物流这些就是它的子域。但如果把订单看成一个领域，那么商品、订单明细等就是它的子域。

如下图，我们可以把电商系统看作领域，然后进行这样的划分：

![image-20211210134916516.png](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-9/84bc24d38e7a4d7f8e245d0ab37dc5f2~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

把电商系统看成一个大领域，根据功能职责划分为订单子域、物流子域等。分布式系统中，往往我们把这种细粒度划分出来的子域看成微服务。把微服务看成一个大的领域范畴，微服务内部的小模块就是我们的子子域。按照这种方式我们可以建立起一个`领域树`。

对于同一父级领域而言，根据子域在父级领域下的业务价值又可以将子域划分为**核心域、支撑域和通用域**。

**1. 核心域**

核心域是业务系统的核心，它是业务系统核心价值的体现。**核心域的划分标准是根据系统的定位而决定的**。比如，把桃子树看成一个系统，如果它存在果园中，那么桃子是它的核心域；如果它存在于花园中，那么桃花是它的核心域。

**2. 支撑域**

这种子域它本身没有核心域对于业务价值那么突出，但是业务系统根据核心域开展业务时又需要依赖它。比如，安全气囊对于车辆而言，它不会成为车辆这个系统的核心卖点，但是它如果没有，一定会影响到车辆的价值。并且不同的车型，安全气囊的规格（比如大小）也是不一样的，这就是支撑域的业务定制性，**强业务相关，但又非核心**。

**3. 通用域**

通用域的核心诉求是稳定与高兼容性，它能够被移动至其他的领域下。比如，在订单领域中，用户与权限就是它的通用域。同样的，这个子域能够在几乎不修改核心逻辑的情况下被应用至物流领域中。

## 二、限界上下文与通用语言

在前面桃树的例子中，在果园跟花园中桃树所对应的核心域是不一样的。

**造成这种子域划分差异的原因是什么？**

我们从具体的语义环境出发去思考了核心域的划分是导致差异的主要原因。而这种具体语义环境就是`上下文`。桃子是核心域时，它的上下文是果园；桃花是核心域时，它的上下文是花园。花园跟果园在各自的上下文中开展业务，**不会互相入侵上下文**。花园的农夫不会去果园养花，果园的农夫不会去花园养果子，这就是不同上下文之间的边界。

**限界上下文意味着特定的、具有明确边界的语义环境，定义了领域的业务边界。**

在同一个限界上下文中，我们对于领域内所有内容的认知应该都是一致的。相信大家在需求开发过程中遇到过跟产品、业务人员、测试“扯皮”的头疼时刻，为了解决这个问题，我们需要有一套通用语言来消除项目相关的人员对领域内的业务逻辑、流程处理规则、专业术语的信息差。

通用语言表示着对领域内的一切动词、名词、形容词达到了一致的认知。比如，我们在果园的限界上下文里认为桃树是用来生产桃子的，而不是用来开桃花的。

## 三、上下文映射图

电商领域中下有订单领域、物流领域等子域。商品这个属性在订单上下文与物流上下文中都是存在的，只是在不同的上下文中地位不同而已。但是，商品的信息会随着业务的进行从订单上下文流转到物流上下文。这种上下文之间的协作模式可以用上下文映射图表示。

上下文映射图分为以下几种方式。

**1. 合作关系**

合作关系映射如下图所示：

![image-20211210184740436.png](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-9/548811c3dfac437986f00ef201dde867~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

A、B 两个限界上下文是为了完成某一功能建立起合作关系。同时成功，同时失败，合作的频率与它们的耦合程度是成正比的。如果它们之间的耦合程度愈演愈烈，则需要考虑是否两个限界上下文应该合并，它们本身就是一个上下文。

**2. 共享内核**

共享内核关系映射如下图所示：

![image-20211210185416284.png](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-9/276db68dd8a04548b163c91cc69413b6~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

如果两个上下文在各自开展业务的过程中都需要使用到一个公有的能力点，则将这个公有的逻辑子集给抽离出来共享，类似于基础工具能力。这个子集的变化将影响所有被关联的限界上下文内部逻辑。

这里需要注意`共享内核`与`通用域`的区别。共享内核的定位是工具基础能力，是为了提供领域完成业务所需要的能力。通用域本质上还是一个子域，它可以去使用共享内核，而共享内核不能关联通用域。

**3. 客户方－供应方开发**

客户方-供应方开发映射关系如下图所示：

![image-20211210193952686.png](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-9/c1084fbb39a64782a4bcd6b286b0b963~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

这种在上下游依赖关系的系统中比较常见，它们由两个不同的团队维护。上游需求开发完，下游使用上游提供的能力再进行开发。

**4. 追随者**

类似于客户方-供应方开发模式，但是上游不提供能力，只提供模型。

**5. 防腐层**

防腐层关系映射如下图所示：

![image-20211210193339247.png](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-9/966ee3e9a5984f2782bcbbc17191cd52~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

上下文 A 与上下文 B 之间不直接进行交互，而是通过定义一个防腐接口进行交互。上下文 A 至依赖接口的标准，而上下文 B 给接口所提供的逻辑上下文 A 无法直接感知。

**DDD 中防腐层是系统内上下文与系统外上下文交互的最主要手段。**

**6. 开放主机服务**

开放主机服务关系映射如下图所示：

![image-20211210193602590.png](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-9/19e4249e8b5f4e449f9736b90fbc77d6~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

与防腐层有点类似，防腐层是把防腐能力定义在了调用方，而开放主机是在被调用方定义了调用规则或者接口协议，由调用方来调用标准接口。

**7. 发布语言**

![image-20211210194348527.png](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-9/07244cd1df99410a9f66ee39236ea0c3~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

类似于开放主机服务与防腐层的逻辑，只不过把规范定义在两个上下文之间，它们之间的协作通过统一的标准进行交互。比如，上下文 A 与上下文 B 之间通过 MQ 中间件进行交互。

**8. 另谋他路**

另谋他路关系映射如下图所示：

![image-20211210191118874.png](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-9/2cc80b2c84ac4345ab423543ba032d2a~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

这种关系模式在大型应用系统特别常见。两个上下文之间毫无关联，独立开展业务。

**9. 大泥球**

大泥球关系映射如下图所示：

![image-20211210192243825.png](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-9/4ed8ff8b1c8f44ecb6c52466d2e9a6c2~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

这种模式在历史项目中比较常见，业务迭代事件长，内部逻辑复杂，业务边界梳理困难。为了不让这种情况往外扩散，把这个系统当成一个黑盒子，只用它提供的接口能力，不严格定义它内部逻辑边界。

## 四、架构风格

前面我们从业务领域划分、领域边界确认、上下文协作的角度理清了 DDD 在应对大型应用系统时，如何一步步地拆分业务，关联业务的解决方案。

但这终究还是停留在业务分析层面，那么它分层的架构又是什么样的呢？

下图是 DDD 的六边形架构：

![1595145053324-34eb42e7-5ff1-469a-855c-bcd144dcfa26.jpeg](https://typora-imagehost-1308499275.cos.ap-shanghai.myqcloud.com/2022-9/b88975548d2d4a959b886f1016b2981a~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

在这个架构下，领域模型是逻辑处理的出入口，应用服务层是业务功能点的出入口，是整个系统对外的门面。一切外部输入均需要通过应用服务层来处理，再通过应用服务层返回。这种方式下，我们平等地看待例如 Web、RPC、MQ 等外部服务，认为它们都属于用户接口层。所有的外部服务通过应用服务提供的接口来访问领域模型。

## 五、总结

本文介绍了 DDD 的战略思想，这是落地过程中非常重要的一步，它让我们明白了 DDD 从大方向上到底如何一步步去实现系统的拆分与领域的建立。

通过本文，我们知道了将业务系统看成一个大领域的情况下，根据业务系统的侧重定位来划分系统下不同的子域。我们能够使用通用语言在领域的限界上下文中进行逻辑处理，不同的限界上下文之间根据业务的不同有不同的协作方式，我们称之为**上下文映射图**。

文章的结尾结合介绍了 DDD 使用六边形架构来独立领域模型与屏蔽外部依赖。