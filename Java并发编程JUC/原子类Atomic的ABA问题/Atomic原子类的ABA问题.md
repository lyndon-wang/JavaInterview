# Atomic原子类

## 1.ABA问题

在多线程场景下`CAS`会出现`ABA`问题，例如有2个线程同时对同一个值(初始值为A)进行CAS操作，这两个线程如下

> 1. 线程1，期望值为A，欲更新的值为B
> 2. 线程2，期望值为A，欲更新的值为B

线程`1`抢先获得CPU时间片，而线程`2`因为其他原因阻塞了，线程`1`取值与期望的A值比较，发现相等然后将值更新为B，然后这个时候**出现了线程`3`，期望值为B，欲更新的值为A**，线程3取值与期望的值B比较，发现相等则将值更新为A，此时线程`2`从阻塞中恢复，并且获得了CPU时间片，这时候线程`2`取值与期望的值A比较，发现相等则将值更新为B，虽然线程`2`也完成了操作，但是线程`2`并不知道值已经经过了`A->B->A`的变化过程。

### 1.1-`ABA`问题带来的危害：

 小明在提款机，提取了50元，因为提款机问题，有两个线程，同时把余额从100变为50

>  线程1（提款机）：获取当前值100，期望更新为50， 线程2（提款机）：获取当前值100，期望更新为50， 线程1成功执行，线程2某种原因block了，这时，某人给小明汇款50 线程3（默认）：获取当前值50，期望更新为100， 这时候线程3成功执行，余额变为100， 线程2从Block中恢复，获取到的也是100，compare之后，继续更新余额为50！！！

 此时可以看到，实际余额应该为**100**（100-50+50），但是实际上变为了**50**（100-50+50-50）这就是ABA问题带来的危害。